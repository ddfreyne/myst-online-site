#!/usr/bin/env ruby

#### Compilation

compile '/assets/*' do |rep|
  rep.filter :rainpress
  rep.filter :relativize_paths, :type => :css
  rep.write
end

compile '/sitemap_xml/' do |rep|
  rep.filter :erb
  rep.write
end

compile '/*/feed_private/' do |rep|
  rep.filter :erb
  rep.write
end

compile '*' do |rep|
  # language-based redirects
  if rep.item[:kind] == 'redirect'
    rep.filter :erb
    rep.write
  # articles that are included in other pages
  elsif rep.item[:kind] == 'article'
    rep.filter :erb
  # normal pages
  else
    rep.filter :erb
    rep.filter :italicize_proper_names
    rep.layout 'default'
    rep.filter :rubypants_ddfreyne
    rep.filter :relativize_paths, :type => :html
    rep.write
  end
end

#### Routing

route '/sitemap_xml/' do |rep|
  '/sitemap.xml'
end

route '/en/errors/404/' do |rep|
  '/error-404.php'
end

route '/en/errors/410/' do |rep|
  '/error-410.php'
end

route '/assets/*' do |rep|
  # build path with version
  rep.item.identifier[0..-2] + '-v' + rep.item[:version].to_s + '.css'
end

route '/*/feed_private/' do |rep|
  # custom path for historical reasons
  rep.item.identifier[%r{^(.*/)feed_private/}, 1] + '_feed.xml'
end

route '*' do |rep|
  if rep.item[:kind] == 'redirect'
    rep.item.identifier + 'index.php'
  else
    rep.item.identifier + 'index.html'
  end
end

#### Layout

layout '*' => :erb
